<!DOCTYPE html>
<html lang="ps">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>د شهید معلومات پاڼه</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      text-align: right;
      margin: 20px;
      background: white;
    }
    .container {
      width: 100%;
      display: flex;
      justify-content: center;
    }
    .content {
      width: 90%;
      padding: 20px;
      background: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th,
    td {
      border: 1px solid black;
      padding: 8px;
      text-align: right;
      vertical-align: top;
    }
    input,
    select {
      width: 100%;
      border: none;
      outline: none;
      text-align: center;
    }
    .header {
      text-align: center;
      font-weight: bold;
      font-size: large;
    }
    .header p .logo {
      position: absolute;
      left: 81%;
      top: 51px;
      width: 159px;
      height: 153px;
    }
    * {
      font-size: large;
    }
    .image-wrapper {
      position: absolute;
      border: 2px dashed rgb(51, 51, 51);
      overflow: hidden;
      cursor: move;
    }
    .wide-column {
      width: 50%;
      text-align: right;
      vertical-align: middle;
      padding: 10px;
    }
    .signature {
      text-align: center;
      margin-top: 20px;
    }
    .buttons {
      text-align: center;
      margin-top: 20px;
    }
    .image-upload {
      text-align: center;
      margin-bottom: 30px;
    }
    .image-preview {
      width: 100%;
      object-fit: cover;
      border: 1px solid black;
    }
    .rotated {
      writing-mode: vertical-lr;
      transform: rotate(180deg);
      text-align: center;
      vertical-align: middle;
      width: 4%;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="content" id="capture">
      <div class="header">
        <p>افغانستان اسلامي امارت</p>
        <p>د متفرقه شهيدانو او معيوبينو د ثبت مدیریت <img class="logo" id="logoImg" src="afg.png" alt="" /></p>
        <p>د شهید معلومات پاڼه</p>
        <p>نيټه <span id="editableDate" contenteditable="true">2014 ۱۴۴۵</span></p>
      </div>
      <span style="position: relative; left: -6%;">
        <p>سلسله شميره: ( <input type="text" id="docNumber" style="width: 50px;"> )</p>
      </span>
      <table>
        <tr>
          <td width="50%" rowspan="22" class="wide-column">
            <div class="image-upload">
              <label for="imageInput" style="cursor: pointer;">شهید انځور</label>
              <input type="file" id="imageInput" accept="image/*" onchange="previewImage()" style="display: none;">
              <br>
              <img id="imagePreview" class="image-preview" src="" alt="شهید انځور">
            </div>
            <strong>د دې پاڼې د ليکلو په اړه لارښوونې</strong>
            <p>۱- په افغانستان کی د امريکايي اشغالګرو او د کابل غلامي ادارې په مقابل کې‌ شهيدانو معلومات بايد په دې پاڼه کي وليکل شي </p>
            <p>۲- د شهيد اړونده پوره معلومات بايد د دې پاڼې مطابق په دقيق ډول وليکل شي </p>
            <p>۳- د معلومات پاڼه بايد د ډلګۍ مشر او د تشکيلاتو د مربوطه مسؤل له تصديق او لاسليک وروسته د متفرقه شهيدانو د مدیریت نماينده ته وسپارل ش</p>
          </td>
          <td style="display: none" width="20%"><input type="text"></td>
          <td style="display: none" width="21%" colspan="2">سلسله شمیره</td>
        </tr>
        <tr>
          <td><input type="text" id="docName"></td>
          <td>اصلي نوم</td>
          <td rowspan="4" class="rotated">پيژندنه</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td>مستعار نوم</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td>د پلار نوم</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td>د‌نيکه نوم</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td>ولایت / صوبه</td>
          <td rowspan="3" class="rotated">اصلي استوګنځی</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td>ولسوالي / ضلع</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td>کلی / محله</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td>ولایت / صوبه</td>
          <td rowspan="3" class="rotated">اوسني استوګنځی</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td>ولسوالي / ضلع</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td>کلی / محله</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td colspan="2">قوم</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td colspan="2">مدني حالت</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td colspan="2">د اولادونو تعداد، نومونه او عمرونه</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td colspan="2">اقتصادي حالت</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td colspan="2">شهادت کیفیت</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td colspan="2">شهادت ځای</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td colspan="2">شهادت نیټه</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td colspan="2">مربوطه مسئول</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td colspan="2">چا سره تشکيل کې شهيد شوي</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td colspan="2">د کورنۍ د سرپرست نوم او مبايل شمېره</td>
        </tr>
      </table>
      <div class="signature">
        <p>
          <span style="margin-left:254px;">د ډلګۍ مشر لاسليک: 
            <span style="position:relative;top: 27px;left: 110px;">( <input type="text" style="width: 74px;"> )</span></span>
          <span>
            <label for="signatureImageInput" style="cursor: pointer;">د تشکيلاتو د موجوده مسؤل لاسليک:</label>
            <input type="file" id="signatureImageInput" accept="image/*" style="display: none;">
            <div id="signatureImageContainer" style="display: inline-block; position: relative;"></div>
          </span>
        </p>
      </div>
    </div>
  </div>
  <div class="buttons">
    <button onclick="exportToPDF()">د PDF بڼه</button>
    <button onclick="exportToImage()">د انځور بڼه</button>
  </div>
<script>
  const DATE_KEY = 'formDocDate';
  const IMAGE_SETTINGS_KEY = 'imageSettings';

  function styleEditableDate(element) {
    const text = element.textContent.trim();
    const parts = text.split(/\s+/);
    if (parts.length === 2) {
      const gregorianYear = parts[0];
      const hijriYear = parts[1];
      element.innerHTML =
        `<span style="font-family: Arial, sans-serif; font-weight: bold;">${gregorianYear}</span> ` +
        `<span style="font-family: 'Noto Naskh Arabic', 'Traditional Arabic', sans-serif; font-weight: bold;">${hijriYear}</span>`;
    }
    function toEasternArabicNumerals(str) {
  const easternDigits = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  return str.replace(/\d/g, d => easternDigits[d]);
}

// Apply it to your element:
const el = document.querySelector("#editableDate > span:nth-child(2)");
if (el) {
  el.textContent = toEasternArabicNumerals(el.textContent);
}
  }

  function previewImage() {
    const input = document.getElementById("imageInput");
    const preview = document.getElementById("imagePreview");
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        setTimeout(saveImageSettings, 100);
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function getFileName() {
    const docNumber = document.getElementById("docNumber").value.trim() || "نامعلوم";
    const docName = document.getElementById("docName").value.trim() || "نامعلوم";
    const today = new Date().toISOString().split("T")[0];
    return `شهید-${docNumber}-${docName}-${today}`;
  }

  document.addEventListener("DOMContentLoaded", function() {
    const table = document.querySelector("table");
    const firstCell = table.rows[0].cells[0];
    table.style.direction = "ltr";
    firstCell.style.direction = "rtl";
    firstCell.style.textAlign = "right";

    const editableDate = document.getElementById('editableDate');
    const savedDate = localStorage.getItem(DATE_KEY);
    if (savedDate) {
      editableDate.textContent = savedDate;
    }
    styleEditableDate(editableDate);

    editableDate.addEventListener('blur', () => {
      localStorage.setItem(DATE_KEY, editableDate.textContent);
      styleEditableDate(editableDate);
    });

    document.getElementById('signatureImageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        let img = document.getElementById('signatureImg');
        if (!img) {
          img = document.createElement('img');
          img.id = 'signatureImg';
          img.style.width = '120px';
          img.style.height = '60px';
          document.getElementById('signatureImageContainer').appendChild(img);
          wrapImage(img);
        }
        img.src = event.target.result;
        setTimeout(saveImageSettings, 100);
      };
      reader.readAsDataURL(file);
    });

    document.querySelectorAll("img").forEach(img => wrapImage(img));
    loadImageSettings();
  });

  function wrapImage(img) {
    if (!img || img.closest(".image-wrapper")) return;

    var wrapper = document.createElement("div");
    wrapper.className = "image-wrapper";
    var rect = img.getBoundingClientRect();
    wrapper.style.position = "absolute";
    wrapper.style.left = img.style.left || rect.left + "px";
    wrapper.style.top = img.style.top || rect.top + "px";
    wrapper.style.width = img.style.width || (rect.width || 150) + "px";
    wrapper.style.height = img.style.height || (rect.height || 150) + "px";
    img.parentNode.insertBefore(wrapper, img);
    wrapper.appendChild(img);
    img.style.position = "absolute";
    img.style.left = "0";
    img.style.top = "0";
    img.style.width = "100%";
    img.style.height = "100%";
    img.style.objectFit = "cover";

    var resizer = document.createElement("div");
    resizer.className = "resizer";
    resizer.style.width = "15px";
    resizer.style.height = "15px";
    resizer.style.background = "#333";
    resizer.style.position = "absolute";
    resizer.style.bottom = "0";
    resizer.style.right = "0";
    resizer.style.cursor = "nwse-resize";
    resizer.style.zIndex = "10";
    wrapper.appendChild(resizer);
    makeDraggable(wrapper);
    makeResizable(wrapper, resizer);
  }

  function makeDraggable(el) {
    var startX, startY, origX, origY;

    function dragStart(e) {
      if (e.target.classList.contains('resizer')) return;
      var evt = e.touches ? e.touches[0] : e;
      startX = evt.clientX;
      startY = evt.clientY;
      origX = parseInt(el.style.left, 10);
      origY = parseInt(el.style.top, 10);
      document.addEventListener(e.touches ? "touchmove" : "mousemove", dragging, {
        passive: false
      });
      document.addEventListener(e.touches ? "touchend" : "mouseup", dragEnd);
      e.preventDefault();
    }

    function dragging(e) {
      var evt = e.touches ? e.touches[0] : e;
      el.style.left = origX + (evt.clientX - startX) + "px";
      el.style.top = origY + (evt.clientY - startY) + "px";
      e.preventDefault();
    }

    function dragEnd(e) {
      document.removeEventListener(e.touches ? "touchmove" : "mousemove", dragging);
      document.removeEventListener(e.touches ? "touchend" : "mouseup", dragEnd);
      saveImageSettings();
    }
    el.addEventListener("mousedown", dragStart);
    el.addEventListener("touchstart", dragStart, {
      passive: false
    });
  }

  function makeResizable(el, resizer) {
    var startX, startY, startWidth, startHeight;

    function resizeStart(e) {
      e.stopPropagation();
      var evt = e.touches ? e.touches[0] : e;
      startX = evt.clientX;
      startY = evt.clientY;
      startWidth = el.clientWidth;
      startHeight = el.clientHeight;
      document.addEventListener(e.touches ? "touchmove" : "mousemove", resizing, {
        passive: false
      });
      document.addEventListener(e.touches ? "touchend" : "mouseup", resizeEnd);
      e.preventDefault();
    }

    function resizing(e) {
      var evt = e.touches ? e.touches[0] : e;
      el.style.width = startWidth + (evt.clientX - startX) + "px";
      el.style.height = startHeight + (evt.clientY - startY) + "px";
      e.preventDefault();
    }

    function resizeEnd() {
      document.removeEventListener(event.type === 'touchend' ? 'touchmove' : 'mousemove', resizing);
      document.removeEventListener(event.type === 'touchend' ? 'touchend' : 'mouseup', resizeEnd);
      saveImageSettings();
    }
    resizer.addEventListener("mousedown", resizeStart);
    resizer.addEventListener("touchstart", resizeStart, {
      passive: false
    });
  }

  function saveImageSettings() {
    var settings = [];
    document.querySelectorAll(".image-wrapper").forEach(function(wrapper) {
      var img = wrapper.querySelector("img");
      if (img && img.id) {
        settings.push({
          id: img.id,
          src: img.src,
          left: wrapper.style.left,
          top: wrapper.style.top,
          width: wrapper.style.width,
          height: wrapper.style.height
        });
      }
    });
    localStorage.setItem(IMAGE_SETTINGS_KEY, JSON.stringify(settings));
  }

  function loadImageSettings() {
    var saved = JSON.parse(localStorage.getItem(IMAGE_SETTINGS_KEY) || "[]");
    saved.forEach(function(item) {
      if (!item.id) return;
      let img = document.getElementById(item.id);
      if (!img && item.src.startsWith('data:image')) {
        img = document.createElement('img');
        img.id = item.id;
        if (item.id === 'signatureImg') {
          document.getElementById('signatureImageContainer').appendChild(img);
        }
        wrapImage(img);
      }

      if (img) {
        if (img.src !== item.src) {
          img.src = item.src;
        }
        var wrapper = img.closest(".image-wrapper");
        if (wrapper) {
          wrapper.style.left = item.left;
          wrapper.style.top = item.top;
          wrapper.style.width = item.width;
          wrapper.style.height = item.height;
        }
      }
    });
  }

  function hideUIElements() {
    document.querySelectorAll("button, .resizer, #imageInput, #signatureImageInput, label[for='imageInput']").forEach(el => {
      el.dataset.prevDisplay = el.style.display;
      el.style.display = "none";
    });
    document.querySelectorAll(".image-wrapper").forEach(el => el.style.border = "none");
  }

  function showUIElements() {
    document.querySelectorAll("button, .resizer, #imageInput, #signatureImageInput, label[for='imageInput']").forEach(el => {
      if (el.dataset.prevDisplay !== undefined) {
        el.style.display = el.dataset.prevDisplay;
      } else {
        el.style.display = '';
      }
    });
    document.querySelectorAll(".image-wrapper").forEach(el => el.style.border = "2px dashed #333");
  }

  function fixRotatedText() {
    document.querySelectorAll(".rotated").forEach(el => {
      const text = el.innerText.trim();
      if (!text) return;
      const fontSize = window.getComputedStyle(el).fontSize;
      const fontFamily = window.getComputedStyle(el).fontFamily;
      const canvas = document.createElement("canvas");
      canvas.width = el.offsetWidth;
      canvas.height = el.offsetHeight;
      const ctx = canvas.getContext("2d");
      ctx.font = `${fontSize} ${fontFamily}`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText(text, 0, 0);
      el.innerHTML = "";
      el.appendChild(canvas);
      el.dataset.originalText = text;
    });
  }

  function restoreRotatedText() {
    document.querySelectorAll('.rotated').forEach(el => {
      if (el.dataset.originalText) {
        el.innerHTML = el.dataset.originalText;
        delete el.dataset.originalText;
      }
    });
  }

  async function exportToImage() {
    hideUIElements();
    fixRotatedText();
    await new Promise(r => setTimeout(r, 100));
    html2canvas(document.getElementById("capture")).then(canvas => {
      const link = document.createElement("a");
      link.download = getFileName() + ".png";
      link.href = canvas.toDataURL("image/png");
      link.click();
      showUIElements();
      restoreRotatedText();
    });
  }

  async function exportToPDF() {
    hideUIElements();
    fixRotatedText();
    await new Promise(r => setTimeout(r, 100));
    const {
      jsPDF
    } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const capture = document.querySelector("#capture");
    html2canvas(capture, {
      scale: 3
    }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdfWidth = doc.internal.pageSize.getWidth();
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
      doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      doc.save(getFileName() + '.pdf');
      showUIElements();
      restoreRotatedText();
    });
  }
</script>
</body>
</html>